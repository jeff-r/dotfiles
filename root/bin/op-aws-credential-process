#!/usr/bin/env bash
set -euo pipefail

VAULT="Private"
ITEM="AWS CLI access key (edfinity)"
FIELD_ACCESS_KEY_ID="access key id"
FIELD_SECRET_ACCESS_KEY="secret access key"

read_field() {
  local field_name="$1"
  # --reveal prints the actual value for concealed fields
  local val
  val="$(op item get "$ITEM" --vault "$VAULT" --fields "$field_name" --reveal \
        | tr -d '\r' \
        | sed -e 's/[[:space:]]\+$//')"

  # Fail fast if 1Password returned the placeholder text instead of the secret
  if [[ "$val" == *"use 'op item get"*"--reveal'*" ]]; then
    echo "1Password did not reveal field '$field_name'. Are you signed in? (run: eval \"\$(op signin)\")" >&2
    exit 1
  fi

  printf '%s' "$val"
}

ACCESS_KEY_ID="$(read_field "$FIELD_ACCESS_KEY_ID")"
SECRET_ACCESS_KEY="$(read_field "$FIELD_SECRET_ACCESS_KEY")"

[[ -n "$ACCESS_KEY_ID" && -n "$SECRET_ACCESS_KEY" ]] || {
  echo "Missing AWS key material from 1Password" >&2
  exit 1
}

# Exact JSON format for AWS credential_process
printf '{ "Version": 1, "AccessKeyId": "%s", "SecretAccessKey": "%s" }\n' \
  "$ACCESS_KEY_ID" "$SECRET_ACCESS_KEY"

